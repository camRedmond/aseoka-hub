# ASEOKA Hub - GitHub Actions CI/CD
#
# Tests and builds the hub server. Deploy stages disabled until ready.
#
# Required Repository Secrets (Settings > Secrets and variables > Actions):
#   DOCKERHUB_USERNAME - Docker Hub username (getaseoka)
#   DOCKERHUB_TOKEN    - Docker Hub access token (not password)
#
# For deployment (when enabled):
#   SSH_PRIVATE_KEY     - SSH key for VPS access
#   SSH_KNOWN_HOSTS     - Output of `ssh-keyscan your-vps-ip`
#   DEPLOY_HOST         - VPS IP or hostname
#   DEPLOY_USER         - SSH user (usually root or aseoka)

name: Hub CI/CD

on:
  push:
    branches: [main]
    tags: ['v*.*.*']
  pull_request:
    branches: [main]

env:
  DOCKERHUB_IMAGE: getaseoka/hub

jobs:
  # ===========================================================================
  # Lint Stage
  # ===========================================================================
  ruff-check:
    name: Ruff Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install uv
        uses: astral-sh/setup-uv@v4

      - name: Install dependencies
        run: |
          uv venv
          uv sync --all-extras

      - name: Run ruff check
        run: uv run ruff check .

  ruff-format:
    name: Ruff Format
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install uv
        uses: astral-sh/setup-uv@v4

      - name: Install dependencies
        run: |
          uv venv
          uv sync --all-extras

      - name: Check formatting
        run: uv run ruff format --check .

  # ===========================================================================
  # Test Stage
  # ===========================================================================
  unit-tests:
    name: Unit Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install uv
        uses: astral-sh/setup-uv@v4

      - name: Install dependencies
        run: |
          uv venv
          uv sync --all-extras

      - name: Run tests with coverage
        run: |
          uv run pytest tests/ -v --tb=short \
            --junitxml=report.xml \
            --cov=aseoka_hub \
            --cov-report=xml \
            --cov-report=term-missing
        continue-on-error: true  # No tests yet

      - name: Upload coverage reports
        uses: codecov/codecov-action@v4
        if: hashFiles('coverage.xml') != ''
        with:
          files: coverage.xml
          fail_ci_if_error: false

      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always() && hashFiles('report.xml') != ''
        with:
          name: test-results
          path: |
            report.xml
            coverage.xml

  type-check:
    name: Type Check (mypy)
    runs-on: ubuntu-latest
    continue-on-error: true  # Type errors are warnings for now
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install uv
        uses: astral-sh/setup-uv@v4

      - name: Install dependencies
        run: |
          uv venv
          uv sync --all-extras

      - name: Run mypy
        run: uv run mypy aseoka_hub --ignore-missing-imports || true

  # ===========================================================================
  # Build Stage - Docker build only (push disabled)
  # ===========================================================================
  build:
    name: Build Docker Image
    runs-on: ubuntu-latest
    needs: [ruff-check, ruff-format]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    steps:
      - uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build image (no push)
        uses: docker/build-push-action@v6
        with:
          context: .
          push: false
          platforms: linux/amd64
          tags: |
            ${{ env.DOCKERHUB_IMAGE }}:${{ github.sha }}
            ${{ env.DOCKERHUB_IMAGE }}:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

      # TODO: Uncomment when ready to push to Docker Hub
      # - name: Login to Docker Hub
      #   uses: docker/login-action@v3
      #   with:
      #     username: ${{ secrets.DOCKERHUB_USERNAME }}
      #     password: ${{ secrets.DOCKERHUB_TOKEN }}
      #
      # - name: Build and push
      #   uses: docker/build-push-action@v6
      #   with:
      #     context: .
      #     push: true
      #     platforms: linux/amd64
      #     tags: |
      #       ${{ env.DOCKERHUB_IMAGE }}:${{ github.sha }}
      #       ${{ env.DOCKERHUB_IMAGE }}:latest
      #     cache-from: type=gha
      #     cache-to: type=gha,mode=max

  # ===========================================================================
  # Deploy Stage - SSH to VPS (disabled)
  # ===========================================================================
  # TODO: Uncomment when ready to deploy
  # deploy-production:
  #   name: Deploy to Production
  #   runs-on: ubuntu-latest
  #   needs: [unit-tests, build]
  #   if: github.ref == 'refs/heads/main' && github.event_name == 'push'
  #   environment:
  #     name: production
  #     url: https://hub.aseoka.com
  #   steps:
  #     - uses: actions/checkout@v4
  #
  #     - name: Setup SSH
  #       run: |
  #         mkdir -p ~/.ssh
  #         echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
  #         chmod 600 ~/.ssh/id_rsa
  #         echo "${{ secrets.SSH_KNOWN_HOSTS }}" >> ~/.ssh/known_hosts
  #
  #     - name: Deploy to production
  #       run: |
  #         rsync -avz --delete \
  #           --exclude='.git' \
  #           --exclude='.venv' \
  #           --exclude='__pycache__' \
  #           --exclude='*.pyc' \
  #           --exclude='.pytest_cache' \
  #           ./ ${{ secrets.DEPLOY_USER }}@${{ secrets.DEPLOY_HOST }}:/opt/aseoka/hub/
  #
  #         ssh ${{ secrets.DEPLOY_USER }}@${{ secrets.DEPLOY_HOST }} << 'ENDSSH'
  #           cd /opt/aseoka/hub
  #           docker compose down || true
  #           docker compose build --no-cache
  #           docker compose up -d
  #           sleep 10
  #           for i in 1 2 3; do
  #             if curl -sf http://localhost:8000/health; then
  #               echo "Hub deployed successfully!"
  #               exit 0
  #             fi
  #             echo "Attempt $i failed, retrying..."
  #             sleep 5
  #           done
  #           echo "Deployment health check failed"
  #           docker compose logs --tail=50
  #           exit 1
  #         ENDSSH
