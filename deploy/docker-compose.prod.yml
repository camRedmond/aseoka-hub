# =============================================================================
# ASEOKA v5 Production Stack
# =============================================================================
#
# Services:
#   - hub:       FastAPI server (agent connections, API)
#   - dashboard: Next.js client dashboard
#   - landing:   Next.js landing page
#   - nginx:     Reverse proxy with SSL termination
#
# Usage:
#   cd /home/aseoka
#   docker compose -f docker-compose.prod.yml up -d --build
#
# Domains:
#   - hub.aseoka.com / api.aseoka.com  -> hub:8000
#   - app.aseoka.com / admin.aseoka.com -> dashboard:3002
#   - aseoka.com / www.aseoka.com      -> landing:3001
#

services:
  # ===========================================================================
  # Hub - FastAPI server for agent connections and API
  # ===========================================================================
  hub:
    build:
      context: ./aseoka-hub
      dockerfile: Dockerfile
    container_name: aseoka-hub
    restart: unless-stopped
    env_file:
      - .env
    environment:
      - ASEOKA_HUB_HOST=0.0.0.0
      - ASEOKA_HUB_PORT=8000
      - ASEOKA_HUB_DB_PATH=/app/data/hub.db
      - ASEOKA_HUB_REQUIRE_AUTH=true
      - ASEOKA_HUB_LOG_LEVEL=INFO
    volumes:
      - ./data/hub:/app/data
      - ./data/ca:/app/data/ca
    networks:
      - aseoka-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  # ===========================================================================
  # Dashboard - Next.js client dashboard (app.aseoka.com)
  # ===========================================================================
  dashboard:
    build:
      context: ./aseoka-dashboard
      dockerfile: Dockerfile.prod
    container_name: aseoka-dashboard
    restart: unless-stopped
    environment:
      - NODE_ENV=production
      - NEXT_PUBLIC_HUB_URL=https://hub.aseoka.com
      - NEXT_PUBLIC_WS_URL=wss://hub.aseoka.com
      - PORT=3002
    networks:
      - aseoka-network
    depends_on:
      hub:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3002"]
      interval: 30s
      timeout: 10s
      retries: 3

  # ===========================================================================
  # Landing - Next.js landing page (aseoka.com)
  # ===========================================================================
  landing:
    build:
      context: ./aseoka-landing
      dockerfile: Dockerfile
    container_name: aseoka-landing
    restart: unless-stopped
    environment:
      - NODE_ENV=production
      - PORT=3001
    networks:
      - aseoka-network
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:3001"]
      interval: 30s
      timeout: 10s
      retries: 3

  # ===========================================================================
  # Nginx - Reverse proxy with SSL termination
  # ===========================================================================
  nginx:
    image: nginx:1.25-alpine
    container_name: aseoka-nginx
    restart: unless-stopped
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx/aseoka.conf:/etc/nginx/conf.d/default.conf:ro
      # Mount acme.sh certs (auto-updates on renewal)
      - /home/aseoka/.acme.sh/aseoka.com_ecc:/etc/nginx/ssl/aseoka.com:ro
    networks:
      - aseoka-network
    depends_on:
      - hub
      - dashboard
      - landing
    healthcheck:
      test: ["CMD", "nginx", "-t"]
      interval: 30s
      timeout: 10s
      retries: 3

networks:
  aseoka-network:
    name: aseoka-network
    driver: bridge
